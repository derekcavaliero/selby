!function(a,b,c,d){function e(b,c){this.element=a(b),this.options=a.extend(!0,{},g,c),this._defaults=g,this._fields=this.options.fields,this._questions=this.options.questions,this._name=f,this._tpl=h,this._storage={},this.init()}var f="selby",g={botName:"Selby",dataEndpoint:!1,fields:{name:{type:"text",placeholder:"First and last name"}},questions:{start:{bot:"Hey there, I'm {{botName}}! I might look like Derek, but im just a machine living in a human's world. <strong>Now that you know my name, what's yours?</strong>",prompt:"Hey {{botName}}, nice to meet you!<br> <strong>My name is</strong>",fields:["name"]}},dataFilter:null,onStepReady:null,onComplete:null},h={bot:Handlebars.compile('<div class="bubble bubble--bot"><div class="bubble__inner">{{{smartString bot userInput}}}</div></div>'),user:Handlebars.compile('<form class="bubble bubble--user"><div class="bubble__inner">{{{ smartString prompt userInput }}}{{{fields}}}<input type="hidden" name="step" value="{{stepKey}}"></div></form>')};e.prototype={init:function(){var a=this;Handlebars.registerHelper("smartString",function(b,c){for(var d in c)c.hasOwnProperty(d)&&(b=b.replace("{{"+d+"}}","<mark>"+c[d]+"</mark>"));return b=b.replace("{{botName}}",a.options.botName),new Handlebars.SafeString(b)}),this.element.addClass("selby"),this.setupListeners(),this.processStep()},setupListeners:function(){var b=this;this.element.on("submit",".bubble--user",function(c){c.preventDefault();var d=a(this),e=b.serializeObject(d);b._storage=a.extend({},b._storage,b.transformInput(e)),console.log(b._storage),d.find(".bubble__input").prop("disabled",!0),d.find(".bubble__button").hide(),b.processStep(b.determineNextStep(b._questions[e.step]))}),this.element.on("change",".bubble__input--select, .bubble__input--radio",function(b){var c=a(this);if(c.data("proceed-on-change")){var d=c.parents("form");c.prop("disabled")?b.preventDefault():d.submit()}})},processStep:function(b){null==b&&(b="start");var c=this._questions[b];this.element.append(h.bot({bot:c.bot,userInput:this._storage})),c.prompt||(c.prompt="");var d={prompt:c.prompt,stepKey:b,userInput:this._storage};c.fields&&(d.fields=this.renderFields(c.fields,b));var e=a(h.user(d)).appendTo(this.element),f=this.element.find(".bubble--bot:last");"start"!==b&&a("html, body").animate({scrollTop:f.offset().top},500),this.options.onStepReady.contructor===Function&&this.options.onStepReady(e),c.sendData===!0&&this.processData()},renderFields:function(a,b){var c=this,d="",e=a.length,f=!1,g=["text","tel","email","number","textarea","checkbox"],h=' data-proceed-on-change="'+(1===e?"true":"false")+'"';return a.forEach(function(a){d+='<div class="bubble__field">';var b=c._fields[a],i="bubble__input bubble__input--"+b.type,j=' name="'+a+'" class="'+i+'" required ';switch(b.label&&(d+='<label class="bubble__input-label" for="'+a+'Field">'+b.label+"</label>"),b.type){case"text":case"email":case"number":case"tel":d+="<input"+j+' type="'+b.type+'" placeholder="'+b.placeholder+'" id="'+a+'Field">';break;case"select":d+="<select"+j+h+' id="'+a+'Field">';for(var k in b.options)b.options.hasOwnProperty(k)&&(d+='<option value="'+k+'">'+b.options[k]+"</option>");d+="</select>";break;case"radio":d+='<div class="bubble__radios">';for(var k in b.options)b.options.hasOwnProperty(k)&&(d+='<input type="radio"'+j+h+'autocomplete="off" value="'+k+'" id="'+a+"--"+k+'"><label for="'+a+"--"+k+'">'+b.options[k]+"</label>");d+="</div>";break;case"textarea":d+="<textarea"+j+' placeholder="'+b.placeholder+'" id="'+a+'Field"></textarea>';break;default:d+="Selby does not currently support "+b.type+" as a valid field type."}d+="</div>",(e>1||g.indexOf(b.type)!==-1)&&(f=!0)}),f&&(d+='<button type="submit" class="bubble__button">Continue</button>'),d},determineNextStep:function(a){var b=a.next;return a.next.constructor===Function&&(b=a.next(this._storage)),b},processData:function(){var b=this.options.dataEndpoint,c=this._storage;delete c.step,this.options.dataFilter.constructor===Function&&(c=this.options.dataFilter(c)),a.ajax({url:b,method:"POST",type:"json",data:c,success:function(a){},error:function(a,b,c){},beforeSend:function(){}})},ucFirst:function(a){return a.replace(/^./,a.substring(0,1).toUpperCase())},serializeObject:function(b){var c={},d=b.serializeArray();return a.each(d,function(){c[this.name]?(c[this.name].push||(c[this.name]=[c[this.name]]),c[this.name].push(this.value||"")):c[this.name]=this.value||""}),c},transformInput:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b].trim();if("name"==b){var d=c.split(" ");a.firstname=this.ucFirst(d[0]),d[1]&&(a.lastname=this.ucFirst(d[1])),delete a[b]}}return a}},a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);