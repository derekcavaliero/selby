/*! 
 * Selby v1.0.0
 * https://github.com/derekcavaliero/selby
 * 
 * Copyright (c) 2018 Derek Cavaliero @ WebMechanix
 * 
 * Date: 2018-04-01 13:48:42 EDT 
 */
!function(a,b,c,d){function e(b,c){this.element=a(b),this.options=a.extend(!0,{},g,a.fn[f].defaults,c),this._defaults=g,this._fields=this.options.fields,this._questions=this.options.questions,this._name=f,this._tpl=h,this._storage={},this.init()}var f="selby",g={botName:"Selby",conversationName:"Selby",messages:{missingFields:"<strong>Sorry {{firstname}}</strong> It looks like I am missing some required information to process your request. Can you please provide the following information?"},fields:{name:{type:"text",placeholder:"First and last name"}},questions:{start:{bot:"<strong>Uh oh!</strong> it appears that my creator forgot to configure me. I'm rather dumb without proper configuration settings unfortunately."}},onStepReady:null,onComplete:null},h={bot:Handlebars.compile('<div class="bubble bubble--bot"><div class="bubble__inner">{{{smartString bot userInput}}}</div></div>'),user:Handlebars.compile('<form class="bubble bubble--user"><div class="bubble__inner">{{{ smartString prompt userInput }}}{{{fields}}}<input type="hidden" name="step" value="{{stepKey}}"></div></form>')};e.prototype={init:function(){var a=this;Handlebars.registerHelper("smartString",function(b,c){for(var d in c)c.hasOwnProperty(d)&&(b=b.replace("{{"+d+"}}","<mark>"+c[d]+"</mark>"));return b=b.replace("{{botName}}",a.options.botName),new Handlebars.SafeString(b)}),this.element.addClass("selby"),this.setupListeners(),this.processStep("start")},setupListeners:function(){var b=this;this.element.on("submit",".bubble--user",function(c){c.preventDefault();var d=a(this),e=b.serializeObject(d);if(b._storage=a.extend({},b._storage,b.transformInput(e)),d.find(".bubble__input").prop("disabled",!0),d.find(".bubble__button").hide(),b._questions[e.step]){var f=b.determineNextStep(b._questions[e.step]);b.processStep(f)}}),this.element.on("change",".bubble__input--select, .bubble__input--radio",function(b){var c=a(this);if(c.data("proceed-on-change")){var d=c.parents("form");c.prop("disabled")?b.preventDefault():d.submit()}})},processStep:function(b){if(b){var c=this._questions[b];if(c.hasOwnProperty("bot")&&this.element.append(h.bot({bot:c.bot,userInput:this._storage})),c.hasOwnProperty("prompt")){var d={prompt:c.prompt,stepKey:b,userInput:this._storage};c.fields&&(d.fields=this.renderFields(c.fields,b));var e=a(h.user(d)).appendTo(this.element)}this.options.onStepReady.constructor===Function&&c.prompt&&this.options.onStepReady(e)}"start"!==b&&this.scrollToLastBotMsg()},renderFields:function(a,b){var c=this,d="",e=a.length,f=!1,g=["text","tel","email","number","textarea","checkbox"],h=' data-proceed-on-change="'+(1===e?"true":"false")+'"';return a.forEach(function(a){d+='<div class="bubble__field">';var b=c._fields[a],i="bubble__input bubble__input--"+b.type,j=' name="'+a+'" class="'+i+'" required ';switch(b.label&&(d+='<label class="bubble__input-label" for="'+a+'Field">'+b.label+"</label>"),b.type){case"text":case"email":case"number":case"tel":d+="<input"+j+' type="'+b.type+'" placeholder="'+b.placeholder+'" id="'+a+'Field">';break;case"select":d+="<select"+j+h+' id="'+a+'Field">';for(var k in b.options)b.options.hasOwnProperty(k)&&(d+='<option value="'+k+'">'+b.options[k]+"</option>");d+="</select>";break;case"radio":d+='<div class="bubble__radios">';for(var k in b.options)b.options.hasOwnProperty(k)&&(d+='<input type="radio"'+j+h+'autocomplete="off" value="'+k+'" id="'+a+"--"+k+'"><label for="'+a+"--"+k+'">'+b.options[k]+"</label>");d+="</div>";break;case"textarea":d+="<textarea"+j+' placeholder="'+b.placeholder+'" id="'+a+'Field"></textarea>';break;default:d+="Selby does not currently support "+b.type+" as a valid field type."}d+="</div>",(e>1||g.indexOf(b.type)!==-1)&&(f=!0)}),f&&(d+='<button type="submit" class="bubble__button">Continue</button>'),d},determineNextStep:function(a){var b=!1;if(b=a.next&&a.next.constructor===Function?a.next(this._storage):a.next,a.sendData||this._questions[b].sendData){var c=a.sendData?a.sendData:this._questions[b].sendData;return this.processData(c),!1}return b},checkRequiredFields:function(){var a=this,b=[];return this.options.requiredFields.forEach(function(c){a._storage[c]||b.push(c)}),b},processData:function(c){var d=this,e=this.options.endpoints[c],f=this._storage;delete f.step,e.dataFilter&&e.dataFilter.constructor===Function&&(f=e.dataFilter(f)),a.ajax({url:e.url,method:"POST",type:"json",data:f,success:function(a){d.element.append(h.bot({bot:"<strong>Thanks {{firstname}}, you're all set!</strong> Please give us some time to process your request. You can generally expect a response within a day or two.",userInput:d._storage})),d.scrollToLastBotMsg(),b.dataLayer?b.dataLayer.push({event:"Send Event",event_category:"Conversions",event_action:"Conversation Complete",event_label:d.options.conversationName}):b.GoogleAnalyticsObject&&b[b.GoogleAnalyticsObject]("send",{hitType:"event",eventCategory:"Conversions",eventAction:"Conversation Complete",eventLabel:d.options.conversationName})},error:function(a,b,c){},beforeSend:function(a,b){d.element.append(h.bot({bot:"<strong>Hang tight!</strong> I'm processing your information. This should only take a moment.",userInput:d._storage})),d.scrollToLastBotMsg();var c=d.checkRequiredFields();if(c.length>0){a.abort();var e=d.options.messages;setTimeout(function(){var a={userInput:d._storage};e.missingFields&&e.missingFields.constructor==Function?a.bot=e.missingFields(d._storage,c,d._defaults.messages.missingFields):a.bot=e.missingFields,d.element.append(h.bot(a)),d.element.append(h.user({prompt:"Sure thing! Here's the remaining information:",userInput:d._storage,stepKey:"end",fields:d.renderFields(c,"end")})),d.scrollToLastBotMsg()},2500)}}})},ucFirst:function(a){return a.replace(/^./,a.substring(0,1).toUpperCase())},scrollToLastBotMsg:function(){var b=this.element.find(".bubble--bot:last");a("html, body").animate({scrollTop:b.offset().top},500)},serializeObject:function(b){var c={},d=b.serializeArray();return a.each(d,function(){c[this.name]?(c[this.name].push||(c[this.name]=[c[this.name]]),c[this.name].push(this.value||"")):c[this.name]=this.value||""}),c},transformInput:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b].trim();if("name"==b){var d=c.split(" ");a.firstname=this.ucFirst(d[0]),d[1]&&(a.lastname=this.ucFirst(d[1])),delete a[b]}}return a}},a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})},a.fn[f].defaults={}}(jQuery,window,document);